<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Startup Debug</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-area {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #333;
            color: #0f0;
            padding: 10px;
            margin: 10px 0;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        .status {
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }
        .status.ok { background: #4CAF50; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.warning { background: #FFC107; color: black; }
    </style>
</head>
<body>
    <h1>üîç Extension Startup Debug</h1>
    
    <div class="test-area">
        <h2>1. Element Check</h2>
        <button onclick="checkElements()">Check All Elements</button>
        <div id="elementStatus"></div>
    </div>
    
    <div class="test-area">
        <h2>2. Button State Test</h2>
        <button onclick="testButtonStates()">Test Button States</button>
        <div id="buttonStatus"></div>
    </div>
    
    <div class="test-area">
        <h2>3. Message System Test</h2>
        <button onclick="testMessaging()">Test Messaging</button>
        <div id="messageStatus"></div>
    </div>
    
    <div class="test-area">
        <h2>4. Manual Relay Start</h2>
        <input type="text" id="testObjective" placeholder="Enter test objective" style="width: 300px; padding: 5px;">
        <button onclick="manualStartRelay()">Start Relay Manually</button>
        <div id="relayStatus"></div>
    </div>
    
    <div class="test-area">
        <h2>Console Log</h2>
        <div class="log" id="logOutput"></div>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logOutput');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'warning' ? '#ff0' : '#0f0';
            logDiv.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        async function checkElements() {
            log('Checking elements in popup...');
            
            // Open popup in a new tab for testing
            const popupUrl = chrome.runtime.getURL('popup.html');
            const tab = await chrome.tabs.create({ url: popupUrl });
            
            // Wait for tab to load
            setTimeout(async () => {
                const result = await chrome.tabs.executeScript(tab.id, {
                    code: `
                        const elements = [
                            'btnStartRelay', 'btnStopRelay', 'relayObjective',
                            'btnOpenAll', 'btnSendAll', 'messageInput'
                        ];
                        const status = {};
                        for (const id of elements) {
                            const el = document.getElementById(id);
                            status[id] = {
                                exists: !!el,
                                disabled: el ? el.disabled : null,
                                type: el ? el.tagName : null
                            };
                        }
                        status;
                    `
                });
                
                const statusDiv = document.getElementById('elementStatus');
                statusDiv.innerHTML = '';
                
                for (const [id, info] of Object.entries(result[0])) {
                    const status = info.exists ? 'ok' : 'error';
                    const disabled = info.disabled ? ' (DISABLED)' : '';
                    statusDiv.innerHTML += `<span class="status ${status}">${id}: ${info.exists ? 'Found' : 'Missing'}${disabled}</span>`;
                    log(`${id}: ${JSON.stringify(info)}`);
                }
                
                // Close the test tab
                setTimeout(() => chrome.tabs.remove(tab.id), 3000);
            }, 1000);
        }
        
        async function testButtonStates() {
            log('Testing button states...');
            
            const result = await chrome.runtime.sendMessage({
                action: 'GET_STATUS'
            });
            
            const statusDiv = document.getElementById('buttonStatus');
            statusDiv.innerHTML = `
                <div>Relay Active: ${result?.relay?.active || false}</div>
                <div>Current Round: ${result?.relay?.currentRound || 0}</div>
                <div>Platforms: ${JSON.stringify(result?.platforms || {})}</div>
            `;
            
            log(`Status: ${JSON.stringify(result)}`);
        }
        
        async function testMessaging() {
            log('Testing message system...');
            
            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'TEST_PLATFORM',
                    platform: 'claude'
                });
                
                const statusDiv = document.getElementById('messageStatus');
                statusDiv.innerHTML = `<span class="status ${response?.success ? 'ok' : 'error'}">
                    Message system: ${response?.success ? 'Working' : 'Failed'}
                </span>`;
                
                log(`Message test: ${JSON.stringify(response)}`);
            } catch (error) {
                log(`Message error: ${error.message}`, 'error');
            }
        }
        
        async function manualStartRelay() {
            const objective = document.getElementById('testObjective').value;
            if (!objective) {
                alert('Please enter an objective');
                return;
            }
            
            log(`Starting relay with: ${objective}`);
            
            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'START_RELAY',
                    objective: objective
                });
                
                const statusDiv = document.getElementById('relayStatus');
                if (response?.success) {
                    statusDiv.innerHTML = '<span class="status ok">Relay Started Successfully!</span>';
                    log('Relay started!', 'info');
                } else {
                    statusDiv.innerHTML = '<span class="status error">Failed to start relay</span>';
                    log(`Relay failed: ${JSON.stringify(response)}`, 'error');
                }
            } catch (error) {
                log(`Error starting relay: ${error.message}`, 'error');
            }
        }
        
        // Auto-check on load
        window.addEventListener('load', () => {
            log('Debug page loaded');
            
            // Check extension status
            chrome.runtime.getBackgroundPage((background) => {
                if (background) {
                    log('Background page accessible');
                } else {
                    log('Background page not accessible', 'warning');
                }
            });
        });
    </script>
</body>
</html>